name: Sync and Relink Binaries

on:
  push:
    branches: [ main ]
  schedule:
  #  - cron: '0 0 * * *'
  workflow_dispatch: 

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download and Patch Script
        run: |
          SOURCE_URL="https://www.baipiao.eu.org/xtunnel/suoha-x.sh"
          # 你的 GitHub Raw 文件基础路径
          MY_RAW_BASE="https://raw.githubusercontent.com/fxpasst1/xtun/main/bin"
          
          echo "=== 1. 下载原始安装脚本 ==="
          curl -sL $SOURCE_URL -o suoha-x.sh
          
          echo "=== 2. 提取并准备下载链接 ==="
          # 提取所有二进制文件的 https 链接
          grep -oE "https://[^ \"'<>)]+" suoha-x.sh | \
          grep -v "suoha-x.sh" | \
          grep -v "github.com" | \
          sort -u > urls.txt
          
          echo "=== 3. 同步文件并修改脚本链接 ==="
          mkdir -p bin/
          
          while IFS= read -r url; do
            filename=$(basename "$url")
            echo "处理文件: $filename"
            
            # 下载二进制文件到 bin 目录
            curl -fL "$url" -o "bin/$filename" || echo "下载失败: $url"
            
            # 【关键步骤】将脚本里的旧链接替换为你自己的 GitHub Raw 链接
            # 使用 | 作为 sed 分隔符以处理 URL 中的斜杠
            sed -i "s|$url|$MY_RAW_BASE/$filename|g" suoha-x.sh
          done < urls.txt
          
          # 清理临时文件
          rm urls.txt

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add suoha-x.sh bin/
          
          if git diff --staged --quiet; then
            echo "没有检测到任何更新。"
          else
            git commit -m "Sync & Relink: Updated binaries and patched suoha-x.sh $(date +'%Y-%m-%d %H:%M:%S')"
            git push
          fi
