name: Sync Binaries from Remote Script

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch: 

jobs:
  sync:
    runs-on: ubuntu-latest
    # 授予写入权限，这是推送到仓库所必须的
    permissions:
      contents: write
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Binaries
        run: |
          SOURCE_URL="https://www.baipiao.eu.org/xtunnel/suoha-x.sh"
          
          # 1. 下载原始脚本用于分析
          curl -sL $SOURCE_URL -o source_script.sh
          
          echo "=== 正在提取下载链接 ==="
          # 改进后的提取逻辑：
          # 寻找包含 https 的行，去掉引号，提取 URL。不再限定文件后缀。
          # 排除掉脚本自身的链接和一些常见的非下载链接
          grep -E "https?://" source_script.sh | \
          grep -oE "https?://[^ \"'<>)]+" | \
          grep -v "baipiao.eu.org" | \
          sort -u > urls.txt
          
          echo "发现的有效链接："
          cat urls.txt
          
          # 2. 创建并进入目录
          mkdir -p bin/
          
          # 3. 循环下载
          while IFS= read -r url; do
            echo "正在下载: $url"
            filename=$(basename "$url")
            # 使用 -C - 支持断点续传，-L 跟随重定向，-o 指定路径
            curl -fL -C - "$url" -o "bin/$filename" || echo "下载失败: $url"
          done < urls.txt
          
          # 清理临时文件
          rm source_script.sh urls.txt

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # 确保 bin 目录被跟踪
          git add bin/
          
          # 检查是否有文件变化
          if git diff --staged --quiet; then
            echo "文件已是最新，无需更新。"
          else
            git commit -m "Auto-sync binaries: $(date +'%Y-%m-%d %H:%M:%S')"
            git push
          fi
